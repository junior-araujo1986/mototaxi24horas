name: ğŸ”§ CI/CD - Frontend Web + App MÃ³vel

on:
  push:
    branches:
      - main

jobs:
  # ğŸ§ª Job 1: Build do Projeto Web (Vite + React)
  build-web:
    name: ğŸŒ Build Frontend Web
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Checkout
        uses: actions/checkout@v4

      - name: ğŸ§ª Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          check-latest: true

      # Instalar dependÃªncias do frontend
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend_vite
          npm install

      # Fazer build do frontend
      - name: ğŸ§± Build Web App
        run: |
          cd frontend_vite
          npm run build

      # Fazer upload do build como artefato
      - name: ğŸ”– Save Web Artifact
        uses: actions/upload-artifact@v3
        with:
          name: dist
          path: frontend_vite/dist/

      # Opcional: Deploy no Firebase (se configurado)
      - name: â˜ï¸ Deploy to Firebase
        if: secrets.FIREBASE_TOKEN != ''
        run: |
          cd frontend_vite
          firebase deploy --only hosting --token ${{ secrets.FIREBASE_TOKEN }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

  # ğŸ“± Job 2: Build do App MÃ³vel (Flutter)
  build-flutter:
    name: ğŸ“² Build App MÃ³vel
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Checkout
        uses: actions/checkout@v4

      - name: ğŸ§ª Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: stable

      # Instalar dependÃªncias do Flutter
      - name: ğŸ“¦ Get Flutter Packages
        run: |
          cd mototaxi_app
          flutter pub get

      - name: ğŸ§± Build APK
        run: |
          cd mototaxi_app
          flutter build apk --release

      # Fazer upload do APK gerado
      - name: ğŸš€ Upload APK Artifact
        uses: actions/upload-artifact@v3
        with:
          name: mototaxi_app_apk
          path: mototaxi_app/build/app/outputs/flutter-apk/app-release.apk

      # Opcional: Build para iOS (se necessÃ¡rio)
      - name: ğŸ Build iOS App
        if: ${{ false }} # Desative por padrÃ£o se nÃ£o for usar
        run: |
          cd mototaxi_app
          flutter build ios --release --no-codesign

  # ğŸ”’ Job 3: VerificaÃ§Ã£o SeguranÃ§a
  lint-and-audit:
    name: ğŸ›¡ï¸ Lint & NPM Audit
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Checkout
        uses: actions/checkout@v4

      - name: ğŸ§ª Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: ğŸ§° Run npm audit and lint
        run: |
          cd frontend_vite
          npm install
          npm run lint
          npm audit fix --force

      - name: ğŸ“‹ Security Scan
        run: |
          echo "âœ… Vulnerabilities fixed using 'npm audit fix --force'"
